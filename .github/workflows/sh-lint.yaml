---
name: lint
on:
    push:

jobs:
    bash-lint:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v5
            - name: Run the sh-checker
              uses: luizm/action-sh-checker@v0.9.0
              with:
                  sh_checker_comment: false

    powershell-lint:
        runs-on: windows-latest
        steps:
            - uses: actions/checkout@v5
            - name: Install PSScriptAnalyzer
              shell: pwsh
              run: Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
            - name: Lint PowerShell scripts
              shell: pwsh
              run: |
                  $files = Get-ChildItem -Path . -Filter *.ps1 -Recurse
                  $issues = @()
                  foreach ($file in $files) {
                      $results = Invoke-ScriptAnalyzer -Path $file.FullName -Severity Error
                      if ($results) {
                          $issues += $results
                          Write-Host "Issues found in $($file.Name):"
                          $results | Format-Table -AutoSize
                      }
                  }
                  if ($issues.Count -gt 0) {
                      Write-Host "Total issues found: $($issues.Count)"
                      exit 1
                  }
                  Write-Host "No issues found!"

    bash-unit:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v5
            - name: Test units
              run: |
                  failed=0
                  for f in tests/*.sh; do
                    echo "Running test: $f"
                    if ! bash "$f" -H; then
                      echo "Test failed: $f"
                      failed=1
                    fi
                  done
                  if [ $failed -eq 1 ]; then
                    echo "Some tests failed"
                    exit 1
                  fi
                  echo "All tests passed"
